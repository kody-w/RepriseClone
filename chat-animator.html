<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Animator - Simple Chat Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            overflow: hidden;
        }

        /* Top Control Bar */
        .control-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-bar h1 {
            font-size: 18px;
            font-weight: 600;
            margin-right: auto;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-purple {
            background: #9b59b6;
            color: white;
        }

        /* Canvas Area */
        .canvas {
            position: fixed;
            top: 60px;
            left: 0;
            right: 300px;
            bottom: 80px;
            background: white;
            overflow: hidden;
        }

        .chat-container {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .message-item {
            position: absolute;
            cursor: move;
            transition: all 0.2s;
            border-radius: 18px;
        }

        .message-item.selected {
            outline: 3px solid #3498db;
            outline-offset: 3px;
        }

        .message-item:hover:not(.selected) {
            transform: scale(1.02);
            filter: brightness(0.98);
        }

        /* Right Sidebar */
        .sidebar {
            position: fixed;
            top: 60px;
            right: 0;
            width: 300px;
            bottom: 80px;
            background: #f8f9fa;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .sidebar .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .sidebar .section:last-child {
            border-bottom: none;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .input-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .message-list {
            list-style: none;
        }

        .message-list-item {
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-list-item:hover {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .message-list-item.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .message-list-item .type {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .message-list-item .preview {
            font-size: 12px;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Timeline */
        .timeline {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: #34495e;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .timeline-track {
            flex: 1;
            height: 40px;
            background: #2c3e50;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .timeline-marker {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #e74c3c;
            top: 0;
            transition: left 0.1s linear;
        }

        .timeline-frames {
            display: flex;
            height: 100%;
        }

        .timeline-frame {
            flex: 1;
            border-right: 1px solid #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .timeline-frame:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        .timeline-frame.active {
            background: rgba(52, 152, 219, 0.4);
        }

        /* Import/Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-content textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .status-message {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: #27ae60;
            color: white;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.error {
            background: #e74c3c;
        }

        /* Inline editing styles */
        [contenteditable="true"] {
            position: relative;
        }

        [contenteditable="true"]:hover {
            background: rgba(52, 152, 219, 0.1) !important;
            border-radius: 3px;
            transition: background 0.2s;
        }

        [contenteditable="true"]:focus {
            background: rgba(52, 152, 219, 0.15) !important;
            outline: 1px dashed #3498db;
            outline-offset: 2px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Control Bar -->
    <div class="control-bar">
        <h1>Chat Animator</h1>
        <button class="btn btn-primary" onclick="importStyles()">üé® Import Styles</button>
        <button class="btn btn-primary" onclick="exportStyles()">üì§ Export Styles</button>
        <button class="btn btn-primary" onclick="importConversation()">üì• Import Conversation</button>
        <button class="btn btn-success" onclick="addMessage('agent')">‚ûï Add Agent</button>
        <button class="btn btn-success" onclick="addMessage('customer')">‚ûï Add Customer</button>
        <button class="btn btn-purple" onclick="exportConversation()">üí¨ Export Conversation</button>
        <button class="btn btn-purple" onclick="exportFrames()">üíæ Export Frames</button>
        <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
    </div>

    <!-- Canvas -->
    <div class="canvas">
        <div class="chat-container" id="chatContainer">
            <div id="emptyState" style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: #999;
                font-size: 16px;
            ">
                <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
                <div style="font-weight: 600; margin-bottom: 10px;">No messages yet</div>
                <div style="font-size: 14px;">Click "‚ûï Add Agent" or "‚ûï Add Customer" to start</div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="section">
            <h3>Messages</h3>
            <ul class="message-list" id="messageList">
                <li style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                    No messages yet
                </li>
            </ul>
        </div>

        <div class="section" id="editSection" style="display: none;">
            <h3>Edit Selected</h3>
            <div class="input-group">
                <label>Type</label>
                <select id="editType" onchange="updateSelectedMessage()">
                    <option value="agent">Agent</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <div class="input-group" id="editTitleGroup">
                <label>üìå Title/Name <span style="font-size: 11px; font-weight: normal; color: #999;">(Field 1)</span></label>
                <input type="text" id="editTitle" oninput="updateSelectedMessage()" placeholder="e.g., Planning Agent">
                <details style="margin-top: 5px;">
                    <summary style="cursor: pointer; font-size: 11px; color: #666; user-select: none;">Style Options</summary>
                    <div style="padding: 8px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Weight</label>
                            <select id="editTitleWeight" onchange="updateSelectedMessage()" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="">Default</option>
                                <option value="400">Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Size</label>
                            <input type="text" id="editTitleSize" onchange="updateSelectedMessage()" placeholder="14px" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="font-size: 11px; color: #666;">Text Color</label>
                            <input type="text" id="editTitleColor" onchange="updateSelectedMessage()" placeholder="#000000" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                    </div>
                </details>
            </div>
            <div class="input-group" id="editSubtitleGroup" style="display: none;">
                <label>üìù Subtitle <span style="font-size: 11px; font-weight: normal; color: #999;">(Field 2 - Optional)</span></label>
                <input type="text" id="editSubtitle" oninput="updateSelectedMessage()" placeholder="e.g., Analyzing your request...">
                <details style="margin-top: 5px;">
                    <summary style="cursor: pointer; font-size: 11px; color: #666; user-select: none;">Style Options</summary>
                    <div style="padding: 8px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Weight</label>
                            <select id="editSubtitleWeight" onchange="updateSelectedMessage()" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="">Default</option>
                                <option value="400">Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Size</label>
                            <input type="text" id="editSubtitleSize" onchange="updateSelectedMessage()" placeholder="12px" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="font-size: 11px; color: #666;">Text Color</label>
                            <input type="text" id="editSubtitleColor" onchange="updateSelectedMessage()" placeholder="#666666" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                    </div>
                </details>
            </div>
            <div class="input-group">
                <label>üí¨ Message Text <span style="font-size: 11px; font-weight: normal; color: #999;">(Field 3 - Main Content)</span></label>
                <textarea id="editText" oninput="updateSelectedMessage()" placeholder="Enter message text..." style="min-height: 80px;"></textarea>
                <details style="margin-top: 5px;">
                    <summary style="cursor: pointer; font-size: 11px; color: #666; user-select: none;">Style Options</summary>
                    <div style="padding: 8px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Weight</label>
                            <select id="editTextWeight" onchange="updateSelectedMessage()" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="">Default</option>
                                <option value="400">Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Size</label>
                            <input type="text" id="editTextSize" onchange="updateSelectedMessage()" placeholder="14px" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="font-size: 11px; color: #666;">Text Color</label>
                            <input type="text" id="editTextColor" onchange="updateSelectedMessage()" placeholder="#000000" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                    </div>
                </details>
            </div>
            <div class="input-group" id="editTimestampGroup" style="display: none;">
                <label>üïê Timestamp <span style="font-size: 11px; font-weight: normal; color: #999;">(Field 4 - Optional)</span></label>
                <input type="text" id="editTimestamp" oninput="updateSelectedMessage()" placeholder="e.g., 2:30 PM">
                <details style="margin-top: 5px;">
                    <summary style="cursor: pointer; font-size: 11px; color: #666; user-select: none;">Style Options</summary>
                    <div style="padding: 8px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Weight</label>
                            <select id="editTimestampWeight" onchange="updateSelectedMessage()" style="width: 100%; padding: 4px; font-size: 11px;">
                                <option value="">Default</option>
                                <option value="400">Normal (400)</option>
                                <option value="500">Medium (500)</option>
                                <option value="600">Semi-Bold (600)</option>
                                <option value="700">Bold (700)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 11px; color: #666;">Font Size</label>
                            <input type="text" id="editTimestampSize" onchange="updateSelectedMessage()" placeholder="11px" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                        <div style="grid-column: span 2;">
                            <label style="font-size: 11px; color: #666;">Text Color</label>
                            <input type="text" id="editTimestampColor" onchange="updateSelectedMessage()" placeholder="#999999" style="width: 100%; padding: 4px; font-size: 11px;">
                        </div>
                    </div>
                </details>
            </div>
            <div class="input-group">
                <label>Position X</label>
                <input type="number" id="editPosX" oninput="updateSelectedMessagePosition()" placeholder="0">
            </div>
            <div class="input-group">
                <label>Position Y</label>
                <input type="number" id="editPosY" oninput="updateSelectedMessagePosition()" placeholder="0">
            </div>
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="showSubtitle" onchange="toggleOptionalFields()">
                    Show Subtitle
                </label>
                <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                    <input type="checkbox" id="showTimestamp" onchange="toggleOptionalFields()">
                    Show Timestamp
                </label>
            </div>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <button class="btn btn-purple" onclick="exportSingleMessage()" style="flex: 1; font-size: 12px;">
                    üíæ Export Bubble
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedMessage()" style="flex: 1; font-size: 12px;">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>

        <div class="section">
            <h3>Message Templates</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                Save and reuse message bubble styles
            </div>
            <button class="btn btn-primary" onclick="importMessageTemplate()" style="width: 100%; margin-bottom: 10px; font-size: 12px;">
                üì• Import Template
            </button>
            <div id="templateLibrary" style="max-height: 200px; overflow-y: auto;">
                <div style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                    No templates yet
                </div>
            </div>
            <input type="file" id="templateFileInput" accept=".json" style="display: none;" onchange="handleTemplateImport(event)">
        </div>

        <div class="section" id="previewSection" style="display: none;">
            <h3>Rendered Output Preview</h3>
            <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                Exact HTML that will be rendered for this message:
            </div>
            <textarea id="renderedPreview" readonly style="
                width: 100%;
                min-height: 150px;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                font-size: 11px;
                background: #f9f9f9;
                resize: vertical;
                color: #333;
            "></textarea>
            <div style="font-size: 11px; color: #666; margin-top: 10px; margin-bottom: 5px;">
                Character Count: <span id="charCount" style="font-weight: 600;">0</span>
            </div>
            <button class="btn btn-primary" onclick="copyRenderedHTML()" style="width: 100%; margin-top: 5px; font-size: 12px;">
                üìã Copy HTML
            </button>
        </div>

        <div class="section">
            <h3>Animation</h3>
            <div class="input-group">
                <label>Current Frame: <span id="currentFrameLabel">1</span></label>
            </div>
            <div class="input-group">
                <label>Speed (ms)</label>
                <input type="number" id="animSpeed" value="500" min="100" max="3000" step="100">
            </div>
            <button class="btn btn-primary" onclick="togglePlay()" id="playBtn" style="width: 100%;">
                ‚ñ∂Ô∏è Play Animation
            </button>
        </div>
    </div>

    <!-- Timeline -->
    <div class="timeline">
        <button class="btn btn-primary" onclick="prevFrame()">‚èÆÔ∏è</button>
        <button class="btn btn-primary" onclick="togglePlay()" id="playBtn2">‚ñ∂Ô∏è</button>
        <button class="btn btn-primary" onclick="nextFrame()">‚è≠Ô∏è</button>
        <div class="timeline-track">
            <div class="timeline-marker" id="timelineMarker"></div>
            <div class="timeline-frames" id="timelineFrames">
                <div class="timeline-frame">1</div>
            </div>
        </div>
        <span id="frameCounter">Frame 1 / 1</span>
    </div>

    <!-- Import Styles Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h2>Import Styles</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Upload a styles JSON file or paste JSON from the Chat Frame Generator:
            </p>
            <input type="file" id="stylesFileInput" accept=".json" style="margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            <div style="text-align: center; margin: 10px 0; color: #999; font-size: 12px;">OR</div>
            <textarea id="importData" placeholder='{"agentMessageTemplate": {...}, "customerMessageTemplate": {...}}'></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('importModal')" style="background: #95a5a6; color: white;">Cancel</button>
                <button class="btn btn-primary" onclick="processImportStyles()">Import</button>
            </div>
        </div>
    </div>

    <!-- Import Conversation Modal -->
    <div class="modal" id="importConversationModal">
        <div class="modal-content">
            <h2>Import Conversation</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                Upload a conversation JSON file or paste JSON:
            </p>
            <input type="file" id="conversationFileInput" accept=".json" style="margin-bottom: 15px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            <div style="text-align: center; margin: 10px 0; color: #999; font-size: 12px;">OR</div>
            <textarea id="importConversationData" placeholder='{"messages": [...], "metadata": {...}}'></textarea>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('importConversationModal')" style="background: #95a5a6; color: white;">Cancel</button>
                <button class="btn btn-primary" onclick="processImportConversation()">Import</button>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // State
        let messages = [];
        let selectedMessageId = null;
        let agentMessageTemplate = null;
        let customerMessageTemplate = null;
        let agentMessageStyles = null;
        let customerMessageStyles = null;
        let currentFrame = 0;
        let isPlaying = false;
        let playInterval = null;
        let draggedElement = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let messageIdCounter = 0;
        let messageTemplates = []; // Store imported message templates

        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message show' + (type === 'error' ? ' error' : '');
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Import styles modal
        function importStyles() {
            document.getElementById('importModal').classList.add('active');

            // Add file input change handler
            const fileInput = document.getElementById('stylesFileInput');
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('importData').value = event.target.result;
                    };
                    reader.readAsText(file);
                }
            };
        }

        function closeModal(modalId) {
            if (modalId) {
                document.getElementById(modalId).classList.remove('active');

                // Clear inputs when closing
                if (modalId === 'importModal') {
                    document.getElementById('stylesFileInput').value = '';
                    document.getElementById('importData').value = '';
                } else if (modalId === 'importConversationModal') {
                    document.getElementById('conversationFileInput').value = '';
                    document.getElementById('importConversationData').value = '';
                }
            } else {
                // Close all modals
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            }
        }

        // Helper: Apply base styles to HTML template
        function applyStylesToTemplate(htmlString, styles) {
            if (!htmlString || !styles) return htmlString;

            const temp = document.createElement('div');
            temp.innerHTML = htmlString;
            const root = temp.firstElementChild;

            if (!root) return htmlString;

            // Apply each style property to the root element
            Object.entries(styles).forEach(([key, value]) => {
                if (value && value !== 'none' && value !== 'auto' && value !== 'normal') {
                    try {
                        // Convert camelCase to kebab-case for CSS
                        const cssKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                        root.style.setProperty(cssKey, value);
                    } catch (e) {
                        console.warn(`Could not apply style ${key}: ${value}`, e);
                    }
                }
            });

            // Ensure proper display for message bubbles
            if (!root.style.display || root.style.display === 'block') {
                root.style.display = 'inline-block';
            }
            if (!root.style.maxWidth) {
                root.style.maxWidth = '75%';
            }
            if (!root.style.wordWrap) {
                root.style.wordWrap = 'break-word';
            }

            return temp.innerHTML;
        }

        function processImportStyles() {
            const data = document.getElementById('importData').value.trim();
            if (!data) {
                showStatus('Please paste JSON data', 'error');
                return;
            }

            try {
                const imported = JSON.parse(data);

                // Check if this is v2.0 format (clean HTML + separate styles)
                const isV2 = imported.metadata && imported.metadata.version === '2.0';

                if (imported.agentMessageTemplate) {
                    if (isV2 && imported.agentMessageStyles) {
                        // V2 format: Apply styles to clean HTML
                        const styledHTML = applyStylesToTemplate(
                            imported.agentMessageTemplate.html,
                            imported.agentMessageStyles
                        );
                        agentMessageTemplate = {
                            html: styledHTML,
                            originalText: imported.agentMessageTemplate.originalText
                        };
                    } else {
                        // V1 format or no styles: Use HTML as-is
                        agentMessageTemplate = imported.agentMessageTemplate;
                    }
                }

                if (imported.customerMessageTemplate) {
                    if (isV2 && imported.customerMessageStyles) {
                        // V2 format: Apply styles to clean HTML
                        const styledHTML = applyStylesToTemplate(
                            imported.customerMessageTemplate.html,
                            imported.customerMessageStyles
                        );
                        customerMessageTemplate = {
                            html: styledHTML,
                            originalText: imported.customerMessageTemplate.originalText
                        };
                    } else {
                        // V1 format or no styles: Use HTML as-is
                        customerMessageTemplate = imported.customerMessageTemplate;
                    }
                }

                if (imported.agentMessageStyles) {
                    agentMessageStyles = imported.agentMessageStyles;
                }
                if (imported.customerMessageStyles) {
                    customerMessageStyles = imported.customerMessageStyles;
                }

                closeModal('importModal');
                const versionNote = isV2 ? ' (v2.0 clean format)' : '';
                showStatus('Styles imported successfully' + versionNote + '!');
                console.log('Imported and applied styles:', { agentMessageTemplate, customerMessageTemplate });
                renderAllMessages();
            } catch (e) {
                showStatus('Invalid JSON format: ' + e.message, 'error');
                console.error('Import error:', e);
            }
        }

        // Import conversation
        function importConversation() {
            document.getElementById('importConversationModal').classList.add('active');

            // Add file input change handler
            const fileInput = document.getElementById('conversationFileInput');
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('importConversationData').value = event.target.result;
                    };
                    reader.readAsText(file);
                }
            };
        }

        function processImportConversation() {
            const data = document.getElementById('importConversationData').value.trim();
            if (!data) {
                showStatus('Please upload a file or paste JSON data', 'error');
                return;
            }

            try {
                const imported = JSON.parse(data);

                if (!imported.messages || !Array.isArray(imported.messages)) {
                    showStatus('Invalid conversation format: missing messages array', 'error');
                    return;
                }

                // Load messages
                messages = imported.messages.map(msg => ({
                    id: msg.id !== undefined ? msg.id : messageIdCounter++,
                    type: msg.type || 'agent',
                    title: msg.title || '',
                    subtitle: msg.subtitle || '',
                    text: msg.text || '',
                    timestamp: msg.timestamp || '',
                    posX: msg.posX || 50,
                    posY: msg.posY || 50,
                    styles: msg.styles || {
                        title: {fontWeight: '', fontSize: '', color: ''},
                        subtitle: {fontWeight: '', fontSize: '', color: ''},
                        text: {fontWeight: '', fontSize: '', color: ''},
                        timestamp: {fontWeight: '', fontSize: '', color: ''}
                    }
                }));

                // Update counter to avoid ID conflicts
                if (messages.length > 0) {
                    const maxId = Math.max(...messages.map(m => m.id));
                    messageIdCounter = maxId + 1;
                }

                // Reset to first frame
                currentFrame = 0;
                selectedMessageId = null;
                document.getElementById('editSection').style.display = 'none';

                closeModal('importConversationModal');
                updateMessageList();
                renderAllMessages();
                updateTimeline();
                showStatus(`Imported ${messages.length} messages successfully!`);
            } catch (e) {
                showStatus('Invalid JSON format: ' + e.message, 'error');
            }
        }

        // Export conversation
        function exportConversation() {
            if (messages.length === 0) {
                showStatus('No messages to export', 'error');
                return;
            }

            const conversationData = {
                messages: messages,
                metadata: {
                    created: new Date().toISOString(),
                    totalMessages: messages.length,
                    version: '1.0'
                }
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(conversationData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('Conversation exported successfully!');
        }

        // Export styles
        function exportStyles() {
            const hasStyles = agentMessageTemplate || customerMessageTemplate || agentMessageStyles || customerMessageStyles;

            if (!hasStyles) {
                showStatus('No styles to export. Import styles first.', 'error');
                return;
            }

            const stylesData = {
                agentMessageTemplate: agentMessageTemplate,
                customerMessageTemplate: customerMessageTemplate,
                agentMessageStyles: agentMessageStyles,
                customerMessageStyles: customerMessageStyles,
                metadata: {
                    exported: new Date().toISOString(),
                    version: '1.0'
                }
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(stylesData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-styles-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('Styles exported successfully!');
        }

        // Copy rendered HTML to clipboard
        function copyRenderedHTML() {
            const preview = document.getElementById('renderedPreview');
            if (!preview.value) {
                showStatus('No HTML to copy', 'error');
                return;
            }

            navigator.clipboard.writeText(preview.value).then(() => {
                showStatus('HTML copied to clipboard!');
            }).catch(err => {
                showStatus('Failed to copy: ' + err.message, 'error');
            });
        }

        // Add new message
        function addMessage(type) {
            // Calculate better default position - vertical stack
            const messageIndex = messages.length;
            const verticalSpacing = 100; // Space between messages vertically

            const message = {
                id: messageIdCounter++,
                type: type,
                title: type === 'agent' ? 'Agent' : '',
                subtitle: '',
                text: type === 'agent' ? 'Type your message here...' : 'Customer message...',
                timestamp: '',
                posX: type === 'customer' ? 500 : 50, // Customer on right, Agent on left
                posY: 50 + (messageIndex * verticalSpacing),
                // Field-specific styles (overrides template styles)
                styles: {
                    title: {fontWeight: '', fontSize: '', color: ''},
                    subtitle: {fontWeight: '', fontSize: '', color: ''},
                    text: {fontWeight: '', fontSize: '', color: ''},
                    timestamp: {fontWeight: '', fontSize: '', color: ''}
                }
            };

            messages.push(message);
            updateMessageList();
            renderAllMessages();
            updateTimeline();
            showStatus(`${type === 'agent' ? 'Agent' : 'Customer'} message added`);
        }

        // Update message list in sidebar
        function updateMessageList() {
            const listEl = document.getElementById('messageList');

            if (messages.length === 0) {
                listEl.innerHTML = '<li style="text-align: center; color: #999; padding: 20px; font-size: 12px;">No messages yet</li>';
                return;
            }

            listEl.innerHTML = messages.map((msg, index) => `
                <li class="message-list-item ${selectedMessageId === msg.id ? 'active' : ''}"
                    onclick="selectMessage(${msg.id})"
                    data-msg-id="${msg.id}">
                    <div class="type">${msg.type}</div>
                    <div class="preview">${msg.title || msg.text}</div>
                </li>
            `).join('');
        }

        // Select message
        function selectMessage(id) {
            selectedMessageId = id;
            const msg = messages.find(m => m.id === id);

            if (msg) {
                // Ensure styles object exists
                if (!msg.styles) {
                    msg.styles = {
                        title: {fontWeight: '', fontSize: '', color: ''},
                        subtitle: {fontWeight: '', fontSize: '', color: ''},
                        text: {fontWeight: '', fontSize: '', color: ''},
                        timestamp: {fontWeight: '', fontSize: '', color: ''}
                    };
                }

                document.getElementById('editType').value = msg.type;
                document.getElementById('editTitle').value = msg.title || '';
                document.getElementById('editSubtitle').value = msg.subtitle || '';
                document.getElementById('editText').value = msg.text || '';
                document.getElementById('editTimestamp').value = msg.timestamp || '';
                document.getElementById('editPosX').value = msg.posX || 0;
                document.getElementById('editPosY').value = msg.posY || 0;

                // Populate style fields
                document.getElementById('editTitleWeight').value = msg.styles.title.fontWeight || '';
                document.getElementById('editTitleSize').value = msg.styles.title.fontSize || '';
                document.getElementById('editTitleColor').value = msg.styles.title.color || '';

                document.getElementById('editSubtitleWeight').value = msg.styles.subtitle.fontWeight || '';
                document.getElementById('editSubtitleSize').value = msg.styles.subtitle.fontSize || '';
                document.getElementById('editSubtitleColor').value = msg.styles.subtitle.color || '';

                document.getElementById('editTextWeight').value = msg.styles.text.fontWeight || '';
                document.getElementById('editTextSize').value = msg.styles.text.fontSize || '';
                document.getElementById('editTextColor').value = msg.styles.text.color || '';

                document.getElementById('editTimestampWeight').value = msg.styles.timestamp.fontWeight || '';
                document.getElementById('editTimestampSize').value = msg.styles.timestamp.fontSize || '';
                document.getElementById('editTimestampColor').value = msg.styles.timestamp.color || '';

                document.getElementById('editSection').style.display = 'block';
                document.getElementById('editTitleGroup').style.display = msg.type === 'agent' ? 'block' : 'none';

                // Update checkboxes and visibility
                const hasSubtitle = msg.subtitle && msg.subtitle.trim().length > 0;
                const hasTimestamp = msg.timestamp && msg.timestamp.trim().length > 0;
                document.getElementById('showSubtitle').checked = hasSubtitle;
                document.getElementById('showTimestamp').checked = hasTimestamp;
                document.getElementById('editSubtitleGroup').style.display = hasSubtitle ? 'block' : 'none';
                document.getElementById('editTimestampGroup').style.display = hasTimestamp ? 'block' : 'none';

                // Update preview panel
                updatePreviewPanel(msg);
            }

            updateMessageList();
            renderAllMessages();
        }

        // Update preview panel with rendered HTML
        function updatePreviewPanel(msg) {
            if (!msg) {
                document.getElementById('previewSection').style.display = 'none';
                return;
            }

            // Generate the same HTML that would be rendered
            let renderedHTML = generateMessageHTML(msg);

            // Apply custom styles
            renderedHTML = applyCustomStyles(renderedHTML, msg);

            // Display in preview
            const previewTextarea = document.getElementById('renderedPreview');
            previewTextarea.value = renderedHTML;

            // Calculate character count (HTML entities count as one character)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = renderedHTML;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            document.getElementById('charCount').textContent = textContent.length;

            // Show preview section
            document.getElementById('previewSection').style.display = 'block';
        }

        // Generate message HTML (extracted from renderAllMessages for reuse)
        function generateMessageHTML(msg) {
            let messageHTML = '';

            if (msg.type === 'agent' && agentMessageTemplate) {
                messageHTML = agentMessageTemplate.html
                    .replace(/\{\{AGENT_TITLE\}\}/g, `<span data-field="title">${msg.title || 'Agent'}</span>`)
                    .replace(/\{\{TITLE\}\}/g, `<span data-field="title">${msg.title || 'Agent'}</span>`)
                    .replace(/\{\{SUBTITLE\}\}/g, msg.subtitle ? `<span data-field="subtitle">${msg.subtitle}</span>` : '')
                    .replace(/\{\{MESSAGE_TEXT\}\}/g, `<span data-field="text">${msg.text || ''}</span>`)
                    .replace(/\{\{TEXT\}\}/g, `<span data-field="text">${msg.text || ''}</span>`)
                    .replace(/\{\{TIMESTAMP\}\}/g, msg.timestamp ? `<span data-field="timestamp">${msg.timestamp}</span>` : '');

                // Clean up empty elements
                if (!msg.subtitle || !msg.subtitle.trim()) {
                    messageHTML = messageHTML.replace(/<[^>]*>\s*<\/[^>]*>/g, (match) => {
                        return match.includes('{{SUBTITLE}}') ? '' : match;
                    });
                }
                if (!msg.timestamp || !msg.timestamp.trim()) {
                    messageHTML = messageHTML.replace(/<[^>]*>\s*<\/[^>]*>/g, (match) => {
                        return match.includes('{{TIMESTAMP}}') ? '' : match;
                    });
                }
            } else if (msg.type === 'customer' && customerMessageTemplate) {
                messageHTML = customerMessageTemplate.html
                    .replace(/\{\{TITLE\}\}/g, msg.title ? `<span data-field="title">${msg.title}</span>` : '')
                    .replace(/\{\{SUBTITLE\}\}/g, msg.subtitle ? `<span data-field="subtitle">${msg.subtitle}</span>` : '')
                    .replace(/\{\{MESSAGE_TEXT\}\}/g, `<span data-field="text">${msg.text || ''}</span>`)
                    .replace(/\{\{TEXT\}\}/g, `<span data-field="text">${msg.text || ''}</span>`)
                    .replace(/\{\{TIMESTAMP\}\}/g, msg.timestamp ? `<span data-field="timestamp">${msg.timestamp}</span>` : '');

                // Clean up empty elements
                if (!msg.title || !msg.title.trim()) {
                    messageHTML = messageHTML.replace(/<[^>]*>\s*<\/[^>]*>/g, (match) => {
                        return match.includes('{{TITLE}}') ? '' : match;
                    });
                }
                if (!msg.subtitle || !msg.subtitle.trim()) {
                    messageHTML = messageHTML.replace(/<[^>]*>\s*<\/[^>]*>/g, (match) => {
                        return match.includes('{{SUBTITLE}}') ? '' : match;
                    });
                }
                if (!msg.timestamp || !msg.timestamp.trim()) {
                    messageHTML = messageHTML.replace(/<[^>]*>\s*<\/[^>]*>/g, (match) => {
                        return match.includes('{{TIMESTAMP}}') ? '' : match;
                    });
                }
            } else {
                // Fallback styling
                const bgColor = msg.type === 'customer' ? '#0084ff' : '#e4e6eb';
                const textColor = msg.type === 'customer' ? '#ffffff' : '#050505';
                const subtitleColor = msg.type === 'customer' ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.6)';
                const timestampColor = msg.type === 'customer' ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.5)';

                let bubbleContent = '';

                if (msg.type === 'agent' && msg.title && msg.title.trim()) {
                    bubbleContent += `<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;" data-field="title">${msg.title}</div>`;
                }

                if (msg.subtitle && msg.subtitle.trim()) {
                    bubbleContent += `<div style="font-size: 12px; font-style: italic; color: ${subtitleColor}; margin-bottom: 6px;" data-field="subtitle">${msg.subtitle}</div>`;
                }

                if (msg.text && msg.text.trim()) {
                    bubbleContent += `<div style="white-space: pre-wrap;" data-field="text">${msg.text}</div>`;
                }

                if (msg.timestamp && msg.timestamp.trim()) {
                    bubbleContent += `<div style="font-size: 11px; color: ${timestampColor}; margin-top: 6px; text-align: right;" data-field="timestamp">${msg.timestamp}</div>`;
                }

                messageHTML = `<div style="background: ${bgColor}; color: ${textColor}; padding: 10px 14px; border-radius: 18px; max-width: 350px; font-size: 14px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;">${bubbleContent}</div>`;
            }

            return messageHTML;
        }

        // Toggle optional fields
        function toggleOptionalFields() {
            const showSubtitle = document.getElementById('showSubtitle').checked;
            const showTimestamp = document.getElementById('showTimestamp').checked;

            document.getElementById('editSubtitleGroup').style.display = showSubtitle ? 'block' : 'none';
            document.getElementById('editTimestampGroup').style.display = showTimestamp ? 'block' : 'none';

            // Clear values if hiding
            if (!showSubtitle && selectedMessageId !== null) {
                const msg = messages.find(m => m.id === selectedMessageId);
                if (msg) {
                    msg.subtitle = '';
                    document.getElementById('editSubtitle').value = '';
                }
            }
            if (!showTimestamp && selectedMessageId !== null) {
                const msg = messages.find(m => m.id === selectedMessageId);
                if (msg) {
                    msg.timestamp = '';
                    document.getElementById('editTimestamp').value = '';
                }
            }

            renderAllMessages();
        }

        // Update selected message from inputs
        function updateSelectedMessage() {
            if (selectedMessageId === null) return;

            const msg = messages.find(m => m.id === selectedMessageId);
            if (!msg) return;

            // Ensure styles object exists
            if (!msg.styles) {
                msg.styles = {
                    title: {fontWeight: '', fontSize: '', color: ''},
                    subtitle: {fontWeight: '', fontSize: '', color: ''},
                    text: {fontWeight: '', fontSize: '', color: ''},
                    timestamp: {fontWeight: '', fontSize: '', color: ''}
                };
            }

            msg.type = document.getElementById('editType').value;
            msg.title = document.getElementById('editTitle').value;
            msg.subtitle = document.getElementById('editSubtitle').value;
            msg.text = document.getElementById('editText').value;
            msg.timestamp = document.getElementById('editTimestamp').value;

            // Update style values
            msg.styles.title.fontWeight = document.getElementById('editTitleWeight').value;
            msg.styles.title.fontSize = document.getElementById('editTitleSize').value;
            msg.styles.title.color = document.getElementById('editTitleColor').value;

            msg.styles.subtitle.fontWeight = document.getElementById('editSubtitleWeight').value;
            msg.styles.subtitle.fontSize = document.getElementById('editSubtitleSize').value;
            msg.styles.subtitle.color = document.getElementById('editSubtitleColor').value;

            msg.styles.text.fontWeight = document.getElementById('editTextWeight').value;
            msg.styles.text.fontSize = document.getElementById('editTextSize').value;
            msg.styles.text.color = document.getElementById('editTextColor').value;

            msg.styles.timestamp.fontWeight = document.getElementById('editTimestampWeight').value;
            msg.styles.timestamp.fontSize = document.getElementById('editTimestampSize').value;
            msg.styles.timestamp.color = document.getElementById('editTimestampColor').value;

            console.log('Updated message:', JSON.stringify(msg, null, 2));

            document.getElementById('editTitleGroup').style.display = msg.type === 'agent' ? 'block' : 'none';

            // Update preview panel with new values
            updatePreviewPanel(msg);

            updateMessageList();
            renderAllMessages();
        }

        // Update selected message position
        function updateSelectedMessagePosition() {
            if (selectedMessageId === null) return;

            const msg = messages.find(m => m.id === selectedMessageId);
            if (!msg) return;

            msg.posX = parseFloat(document.getElementById('editPosX').value) || 0;
            msg.posY = parseFloat(document.getElementById('editPosY').value) || 0;

            renderAllMessages();
        }

        // Delete selected message
        function deleteSelectedMessage() {
            if (selectedMessageId === null) return;

            if (confirm('Delete this message?')) {
                messages = messages.filter(m => m.id !== selectedMessageId);
                selectedMessageId = null;
                document.getElementById('editSection').style.display = 'none';
                updateMessageList();
                renderAllMessages();
                updateTimeline();
                showStatus('Message deleted');
            }
        }

        // Helper: Apply custom field styles to rendered HTML
        function applyCustomStyles(html, msg) {
            if (!msg.styles) return html;

            // Create a temporary container to parse HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Apply styles to elements with data-field attributes
            const applyToField = (fieldName, styles) => {
                const elements = tempDiv.querySelectorAll(`[data-field="${fieldName}"]`);
                elements.forEach(el => {
                    if (styles.fontWeight) el.style.fontWeight = styles.fontWeight;
                    if (styles.fontSize) el.style.fontSize = styles.fontSize;
                    if (styles.color) el.style.color = styles.color;
                });
            };

            applyToField('title', msg.styles.title);
            applyToField('subtitle', msg.styles.subtitle);
            applyToField('text', msg.styles.text);
            applyToField('timestamp', msg.styles.timestamp);

            return tempDiv.innerHTML;
        }

        // Render all messages on canvas
        function renderAllMessages() {
            const container = document.getElementById('chatContainer');
            const emptyState = document.getElementById('emptyState');

            // Clear existing messages but keep empty state element
            const messagesToRemove = container.querySelectorAll('.message-item');
            messagesToRemove.forEach(msg => msg.remove());

            if (messages.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            } else {
                if (emptyState) emptyState.style.display = 'none';
            }

            const visibleMessages = messages.slice(0, currentFrame + 1);

            visibleMessages.forEach(msg => {
                console.log('Rendering message:', msg.id, 'Title:', msg.title, 'Text:', msg.text);

                const el = document.createElement('div');
                el.className = 'message-item' + (selectedMessageId === msg.id ? ' selected' : '');
                el.dataset.msgId = msg.id;
                el.style.left = (msg.posX || 0) + 'px';
                el.style.top = (msg.posY || 0) + 'px';

                // Use the same HTML generation as preview panel
                let messageHTML = generateMessageHTML(msg);

                // Apply custom field styles
                messageHTML = applyCustomStyles(messageHTML, msg);

                el.innerHTML = messageHTML;

                // Make all text fields editable
                enableInlineEditing(el, msg.id);

                el.addEventListener('mousedown', startDrag);
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectMessage(msg.id);
                });

                container.appendChild(el);
            });
        }

        // Enable inline editing for all text fields in a message
        function enableInlineEditing(messageElement, msgId) {
            const msg = messages.find(m => m.id === msgId);
            if (!msg) return;

            // Find all editable fields (title, subtitle, text, timestamp)
            const editableFields = messageElement.querySelectorAll('[data-field]');

            editableFields.forEach(field => {
                const fieldType = field.getAttribute('data-field');

                // Make contenteditable
                field.contentEditable = 'true';
                field.style.cursor = 'text';
                field.style.outline = 'none';

                // Visual feedback on hover
                field.addEventListener('mouseenter', (e) => {
                    if (e.target.contentEditable === 'true') {
                        e.target.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                    }
                });

                field.addEventListener('mouseleave', (e) => {
                    if (e.target.contentEditable === 'true') {
                        e.target.style.backgroundColor = '';
                    }
                });

                // Save changes on blur or Enter key
                field.addEventListener('blur', () => {
                    saveInlineEdit(msgId, fieldType, field.textContent);
                });

                field.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        field.blur(); // Trigger save
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        // Restore original value
                        field.textContent = msg[fieldType] || '';
                        field.blur();
                    }
                });

                // Prevent dragging when clicking inside editable text
                field.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });

                field.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Select the message so sidebar updates
                    selectMessage(msgId);
                });
            });
        }

        // Save inline edit to message data
        function saveInlineEdit(msgId, fieldType, newValue) {
            const msg = messages.find(m => m.id === msgId);
            if (!msg) return;

            // Update the message data
            msg[fieldType] = newValue;

            console.log(`Saved inline edit: ${fieldType} = "${newValue}"`);

            // Update sidebar if this message is selected
            if (selectedMessageId === msgId) {
                const fieldMap = {
                    'title': 'editTitle',
                    'subtitle': 'editSubtitle',
                    'text': 'editText',
                    'timestamp': 'editTimestamp'
                };

                const inputId = fieldMap[fieldType];
                if (inputId) {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.value = newValue;
                    }
                }

                // Update preview panel
                updatePreviewPanel(msg);
            }

            // Update message list preview
            updateMessageList();

            showStatus(`‚úèÔ∏è ${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)} updated`, 'success');
        }

        // Drag functionality
        function startDrag(e) {
            const msgId = parseInt(e.currentTarget.dataset.msgId);
            selectMessage(msgId);

            draggedElement = e.currentTarget;
            const rect = draggedElement.getBoundingClientRect();
            const containerRect = document.getElementById('chatContainer').getBoundingClientRect();

            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);

            e.preventDefault();
        }

        function onDrag(e) {
            if (!draggedElement) return;

            const containerRect = document.getElementById('chatContainer').getBoundingClientRect();

            let newX = e.clientX - containerRect.left - dragOffsetX;
            let newY = e.clientY - containerRect.top - dragOffsetY;

            newX = Math.max(0, newX);
            newY = Math.max(0, newY);

            draggedElement.style.left = newX + 'px';
            draggedElement.style.top = newY + 'px';
        }

        function stopDrag(e) {
            if (!draggedElement) return;

            const msgId = parseInt(draggedElement.dataset.msgId);
            const msg = messages.find(m => m.id === msgId);

            if (msg) {
                msg.posX = parseFloat(draggedElement.style.left);
                msg.posY = parseFloat(draggedElement.style.top);

                // Update edit inputs
                document.getElementById('editPosX').value = msg.posX;
                document.getElementById('editPosY').value = msg.posY;
            }

            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);

            draggedElement = null;
        }

        // Timeline functions
        function updateTimeline() {
            const totalFrames = Math.max(1, messages.length);
            const framesEl = document.getElementById('timelineFrames');

            framesEl.innerHTML = '';
            for (let i = 0; i < totalFrames; i++) {
                const frameEl = document.createElement('div');
                frameEl.className = 'timeline-frame' + (i === currentFrame ? ' active' : '');
                frameEl.textContent = i + 1;
                frameEl.onclick = () => goToFrame(i);
                framesEl.appendChild(frameEl);
            }

            updateFrameCounter();
            updateTimelineMarker();
        }

        function updateFrameCounter() {
            const total = Math.max(1, messages.length);
            document.getElementById('frameCounter').textContent = `Frame ${currentFrame + 1} / ${total}`;
            document.getElementById('currentFrameLabel').textContent = currentFrame + 1;
        }

        function updateTimelineMarker() {
            const total = Math.max(1, messages.length);
            const percent = (currentFrame / total) * 100;
            document.getElementById('timelineMarker').style.left = percent + '%';
        }

        function goToFrame(index) {
            const total = Math.max(1, messages.length);
            currentFrame = Math.max(0, Math.min(index, total - 1));
            renderAllMessages();
            updateTimeline();
        }

        function prevFrame() {
            goToFrame(currentFrame - 1);
        }

        function nextFrame() {
            goToFrame(currentFrame + 1);
        }

        function togglePlay() {
            isPlaying = !isPlaying;

            const btn1 = document.getElementById('playBtn');
            const btn2 = document.getElementById('playBtn2');

            if (isPlaying) {
                btn1.innerHTML = '‚è∏Ô∏è Pause';
                btn2.innerHTML = '‚è∏Ô∏è';
                play();
            } else {
                btn1.innerHTML = '‚ñ∂Ô∏è Play Animation';
                btn2.innerHTML = '‚ñ∂Ô∏è';
                if (playInterval) {
                    clearInterval(playInterval);
                    playInterval = null;
                }
            }
        }

        function play() {
            if (!isPlaying) return;

            const speed = parseInt(document.getElementById('animSpeed').value) || 500;

            playInterval = setInterval(() => {
                if (currentFrame >= messages.length - 1) {
                    currentFrame = 0;
                } else {
                    currentFrame++;
                }
                renderAllMessages();
                updateTimeline();
            }, speed);
        }

        // Export frames
        function exportFrames() {
            if (messages.length === 0) {
                showStatus('No messages to export', 'error');
                return;
            }

            const frames = [];
            for (let i = 0; i < messages.length; i++) {
                const frameMessages = messages.slice(0, i + 1);
                frames.push({
                    frameNumber: i + 1,
                    messages: frameMessages.map(m => ({
                        type: m.type,
                        title: m.title,
                        text: m.text,
                        posX: m.posX,
                        posY: m.posY
                    }))
                });
            }

            const exportData = {
                frames,
                agentMessageTemplate,
                customerMessageTemplate,
                agentMessageStyles,
                customerMessageStyles
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-animation-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('Frames exported successfully!');
        }

        // Clear all
        function clearAll() {
            if (confirm('Clear all messages? This cannot be undone.')) {
                messages = [];
                selectedMessageId = null;
                currentFrame = 0;
                document.getElementById('editSection').style.display = 'none';
                updateMessageList();
                renderAllMessages();
                updateTimeline();
                showStatus('All messages cleared');
            }
        }

        // Export single message as template
        function exportSingleMessage() {
            if (selectedMessageId === null) {
                showStatus('No message selected', 'error');
                return;
            }

            const msg = messages.find(m => m.id === selectedMessageId);
            if (!msg) {
                showStatus('Message not found', 'error');
                return;
            }

            // Generate the rendered HTML for preview
            let renderedHTML = generateMessageHTML(msg);
            renderedHTML = applyCustomStyles(renderedHTML, msg);

            const template = {
                type: msg.type,
                title: msg.title,
                subtitle: msg.subtitle,
                text: msg.text,
                timestamp: msg.timestamp,
                styles: msg.styles,
                renderedPreview: renderedHTML,
                metadata: {
                    exported: new Date().toISOString(),
                    version: '1.0'
                }
            };

            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `message-template-${msg.type}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('üíæ Message template exported!');
        }

        // Import message template
        function importMessageTemplate() {
            document.getElementById('templateFileInput').click();
        }

        // Handle template import
        function handleTemplateImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const template = JSON.parse(e.target.result);

                    // Validate template
                    if (!template.type || !template.text) {
                        showStatus('Invalid template format', 'error');
                        return;
                    }

                    // Add to templates library
                    template.id = Date.now();
                    messageTemplates.push(template);

                    // Save to localStorage
                    try {
                        localStorage.setItem('chatAnimatorTemplates', JSON.stringify(messageTemplates));
                    } catch (err) {
                        console.warn('Could not save to localStorage:', err);
                    }

                    updateTemplateLibrary();
                    showStatus(`‚úÖ Template imported: ${template.type} message`);

                } catch (error) {
                    showStatus('Error parsing template: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // Clear input
            event.target.value = '';
        }

        // Update template library display
        function updateTemplateLibrary() {
            const libraryEl = document.getElementById('templateLibrary');

            if (messageTemplates.length === 0) {
                libraryEl.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 20px; font-size: 12px;">
                        No templates yet
                    </div>
                `;
                return;
            }

            libraryEl.innerHTML = messageTemplates.map((template, index) => `
                <div style="
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 10px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                " onmouseover="this.style.borderColor='#3498db'; this.style.background='#f0f8ff';"
                   onmouseout="this.style.borderColor='#ddd'; this.style.background='white';"
                   onclick="addMessageFromTemplate(${template.id})">
                    <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: ${template.type === 'agent' ? '#3498db' : '#9b59b6'}; margin-bottom: 5px;">
                        ${template.type}
                    </div>
                    <div style="font-size: 12px; color: #333; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${template.title || template.text}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                        <span style="font-size: 10px; color: #999;">Click to use</span>
                        <button onclick="event.stopPropagation(); deleteTemplate(${template.id})" style="
                            background: #e74c3c;
                            color: white;
                            border: none;
                            border-radius: 3px;
                            padding: 3px 8px;
                            font-size: 10px;
                            cursor: pointer;
                        ">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Add message from template
        function addMessageFromTemplate(templateId) {
            const template = messageTemplates.find(t => t.id === templateId);
            if (!template) {
                showStatus('Template not found', 'error');
                return;
            }

            // Calculate position for new message
            const messageIndex = messages.length;
            const verticalSpacing = 100;

            const message = {
                id: messageIdCounter++,
                type: template.type,
                title: template.title || '',
                subtitle: template.subtitle || '',
                text: template.text || '',
                timestamp: template.timestamp || '',
                posX: template.type === 'customer' ? 500 : 50,
                posY: 50 + (messageIndex * verticalSpacing),
                styles: template.styles || {
                    title: {fontWeight: '', fontSize: '', color: ''},
                    subtitle: {fontWeight: '', fontSize: '', color: ''},
                    text: {fontWeight: '', fontSize: '', color: ''},
                    timestamp: {fontWeight: '', fontSize: '', color: ''}
                }
            };

            messages.push(message);
            updateMessageList();
            renderAllMessages();
            updateTimeline();
            showStatus(`‚úÖ ${template.type} message added from template`);
        }

        // Delete template
        function deleteTemplate(templateId) {
            if (confirm('Delete this template?')) {
                messageTemplates = messageTemplates.filter(t => t.id !== templateId);

                // Save to localStorage
                try {
                    localStorage.setItem('chatAnimatorTemplates', JSON.stringify(messageTemplates));
                } catch (err) {
                    console.warn('Could not save to localStorage:', err);
                }

                updateTemplateLibrary();
                showStatus('Template deleted');
            }
        }

        // Load templates from localStorage on init
        function loadTemplatesFromStorage() {
            try {
                const stored = localStorage.getItem('chatAnimatorTemplates');
                if (stored) {
                    messageTemplates = JSON.parse(stored);
                    updateTemplateLibrary();
                }
            } catch (err) {
                console.warn('Could not load templates from localStorage:', err);
            }
        }

        // Click outside to deselect
        document.getElementById('chatContainer').addEventListener('click', (e) => {
            if (e.target.id === 'chatContainer') {
                selectedMessageId = null;
                document.getElementById('editSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'none';
                updateMessageList();
                renderAllMessages();
            }
        });

        // Initialize
        updateTimeline();
        loadTemplatesFromStorage();
    </script>
</body>
</html>
